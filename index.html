<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grade 10 Genetics Practice</title>
  <style>
    :root { --bg:#0b0c10; --panel:#15171c; --text:#eaf0f5; --muted:#b6c0cb; --accent:#4aa3ff; --good:#20c997; --bad:#ff5c7a; --grid:#2a2e35; --focus:#72c3ff; --mark:#ffd54f; }
    [data-theme="light"] { --bg:#f7f9fc; --panel:#fff; --text:#0f172a; --muted:#475569; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --grid:#e2e8f0; --focus:#60a5fa; --mark:#fde68a; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,transparent,var(--bg) 40%);padding:1rem 1rem .5rem}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h1{font-size:1.5rem;margin:0 0 .25rem}
    p.sub{margin:0;color:var(--muted);font-size:.95rem}

    .toolbar{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--grid);background:transparent;color:var(--text);padding:.6rem .9rem;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:rgba(74,163,255,.08);border-color:var(--accent)}

    .select{height:40px;padding:0 .7rem;border-radius:10px;border:1px solid var(--grid);background:var(--panel);color:var(--text);-webkit-appearance:menulist;appearance:menulist;pointer-events:auto}
    label{font-weight:600}

    .grid{margin-top:.8rem;overflow-x:auto;border:1px dashed var(--grid);border-radius:12px;padding:.5rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.03))}
    .row-label{font-size:.85rem;color:var(--muted);margin:.35rem 0 .15rem}

    .cell{min-width:28px;height:32px;display:flex;align-items:center;justify-content:center;border:1px solid var(--grid);border-radius:6px;background:rgba(255,255,255,.02);font-weight:700;letter-spacing:.3px}
    .slot{min-width:28px;height:32px;border:1px dashed var(--grid);border-radius:6px;opacity:.5}
    .codon{grid-column:span 3;height:40px;display:flex;align-items:center;justify-content:center;border:1px solid var(--grid);border-radius:6px;font-weight:700}
    .word{font-size:.9rem}

    .mark{background:var(--mark)!important;border-color:#f59e0b!important}

    .badcell{background:rgba(255,92,122,.18)!important;border-color:var(--bad)!important}
    .goodcell{background:rgba(32,201,151,.16)!important;border-color:var(--good)!important}
    .neutral{opacity:.7}

    .section-title{display:flex;align-items:center;gap:.5rem;margin:1rem 0 .25rem}
    .pill{font-size:.75rem;padding:.15rem .55rem;border:1px solid var(--grid);border-radius:999px;color:var(--muted)}
    .score{font-size:.9rem;color:var(--muted);margin-left:auto}
    .hint{color:var(--muted);font-size:.85rem}
    .divider{height:1px;background:var(--grid);margin:1rem 0;opacity:.7}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:rgba(0,0,0,.15);padding:0 .35rem;border-radius:6px;border:1px solid var(--grid)}
    .inline-grid{display:grid;grid-auto-flow:column;gap:.35rem;align-items:center}
    .row-head{display:flex; align-items:center; justify-content:space-between; gap:.5rem}

    /* Practice inputs */
    .base-input{width:100%;height:28px;border:1px solid var(--grid);border-radius:6px;background:transparent;text-align:center;font-weight:700;color:var(--text)}
    .base-input:focus{outline:none;box-shadow:0 0 0 2px var(--focus)}
    .codon-input{grid-column:span 3;width:100%;height:40px;border:1px solid var(--grid);border-radius:6px;background:transparent;text-align:center;font-weight:700;color:var(--text)}
    .codon-input.word{font-size:.9rem}
    .error{color:#f87171}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="card" style="display:flex;align-items:center;gap:1rem;">
        <div style="flex:1">
          <h1>Transcription and Translation Practice and Exploration of Mutations</h1>
          <p class="sub">Part 1: Practice • Part 2: Mutations (jump anytime).</p>
        </div>
        <div class="inline-grid">
          <a class="btn" href="#part2" role="button">Jump to Part 2</a>
          <label for="themeToggle">Light</label>
          <input type="checkbox" id="themeToggle" aria-label="Toggle light theme" />
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- PART 1: PRACTICE -->
    <section class="card" id="part1">
      <div class="section-title">
        <strong>Part 1 • Practice</strong>
        <span class="pill" id="currentMeta">Sentence: —</span>
      </div>
      <div class="toolbar" role="group" aria-label="Practice controls">
        <div class="inline-grid">
          <label for="pickNumber">Sentence #</label>
          <select class="select" id="pickNumber" aria-label="Choose sentence number">
            <option value="">—</option>
            <option value="0">1</option>
            <option value="1">2</option>
            <option value="2">3</option>
            <option value="3">4</option>
            <option value="4">5</option>
            <option value="5">6</option>
            <option value="6">7</option>
            <option value="7">8</option>
            <option value="8">9</option>
            <option value="9">10</option>
          </select>
          <button class="btn" id="btnLoad">Load</button>
        </div>
        <button class="btn" id="btnReset">Reset</button>
        <span class="hint">Start transcribing at the first <span class="kbd">AUG</span> (DNA <span class="kbd">TAC</span>). Blanks before <span class="kbd">AUG</span> are ignored; filled entries before then are marked incorrect.</span>
      </div>
      <div id="originalBlock"></div>
    </section>

    <div class="divider"></div>

    <!-- PART 2: MUTATION VIEWER -->
    <section class="card" id="part2">
      <div class="section-title">
        <strong>Part 2 • Mutation Viewer</strong>
        <span class="pill">Select sentence & mutation; view aligned original vs mutated</span>
        <span class="pill" id="p2Status" aria-live="polite"></span>
      </div>
      <div class="toolbar" role="group" aria-label="Mutation controls">
        <div class="inline-grid">
          <label for="pickNumber2">Sentence #</label>
          <select class="select" id="pickNumber2" aria-label="Choose sentence number">
            <option value="">—</option>
            <option value="0">1</option>
            <option value="1">2</option>
            <option value="2">3</option>
            <option value="3">4</option>
            <option value="4">5</option>
            <option value="5">6</option>
            <option value="6">7</option>
            <option value="7">8</option>
            <option value="8">9</option>
            <option value="9">10</option>
          </select>
        </div>
        <div class="inline-grid">
          <label for="mutType2">Mutation type</label>
          <select class="select" id="mutType2" aria-label="Choose mutation type">
            <option value="sub">Substitution</option>
            <option value="del">Deletion</option>
            <option value="ins">Insertion</option>
          </select>
        </div>
        <button class="btn" id="btnRun">Run mutation</button>
        <button class="btn" id="btnResetP2">Reset Part 2</button>
      </div>
      <div id="quickViewer"></div>
    </section>
  </main>

  <!-- Templates for Part 1 practice -->
  <template id="tmpl-block">
    <div class="rowshell">
      <div class="row-label">DNA sequence</div>
      <div class="grid dna-grid" role="region" aria-label="DNA sequence grid"></div>
    </div>
    <div class="rowshell">
      <div class="row-label">Transcription (mRNA)</div>
      <div class="grid mrna-grid" role="region" aria-label="mRNA transcription grid"></div>
      <div class="toolbar">
        <button class="btn" data-action="check-mrna">Check transcription</button>
        <span class="score" data-score-mrna></span>
      </div>
    </div>
    <div class="rowshell">
      <div class="row-label">Translation (3-letter amino acids)</div>
      <div class="grid aa-grid" role="region" aria-label="Amino acids grid"></div>
      <div class="toolbar">
        <button class="btn" data-action="check-aa">Check amino acids</button>
        <span class="score" data-score-aa></span>
      </div>
    </div>
    <div class="rowshell">
      <div class="row-label">Words (they represent amino acids, and the sentence represents a protein)</div>
      <div class="grid words-grid" role="region" aria-label="Words grid"></div>
      <div class="toolbar">
        <button class="btn" data-action="check-words">Check words</button>
        <span class="score" data-score-words></span>
      </div>
    </div>
  </template>

  <script>
    // ===================== DATA =====================
    var state = {
      sequences: [
        'AGGTTGCCGTACCGAGACCCACTTTGAACCCTAATCACTAAATTA',
        'AGCCGGTACGCAGACGTAACCACATGAACCCACACTGGATCTTCCC',
        'CCCCAAATAGGGTACTTATAAACCGTTTGAACCCTAACTGGGTCGCA',
        'TCAGCATCTTACACCTTTCACGACCCATGAACCATAACTATTACCAC',
        'ATTTATGATTCATACACCAAAATAGACGTAACCACAACTGTCTGCAA',
        'TCATGTTACACCCTAGACCCACTTTGAGCAACTTACGTTGA',
        'CAGTACCGAGTAACCACATGAACCCACATCACTTGAGTAC',
        'CACTTATGTTACGCACCACTTTGAACCGGACTAACTCGGACATTAT',
        'GGTGGGGCTTACTTAGACGTAACCGTTTGAACCATAACTTTGGATCG',
        'ATAGTAAGATACACCAGACACGACTAAACCAAAATAATTTATAGCGC'
      ],
      codonToAA: { UUU:'Phe',UUC:'Phe',UUA:'Leu',UUG:'Leu', CUU:'Leu',CUC:'Leu',CUA:'Leu',CUG:'Leu', AUU:'Ile',AUC:'Ile',AUA:'Ile',AUG:'Met', GUU:'Val',GUC:'Val',GUA:'Val',GUG:'Val', UCU:'Ser',UCC:'Ser',UCA:'Ser',UCG:'Ser', CCU:'Pro',CCC:'Pro',CCA:'Pro',CCG:'Pro', ACU:'Thr',ACC:'Thr',ACA:'Thr',ACG:'Thr', GCU:'Ala',GCC:'Ala',GCA:'Ala',GCG:'Ala', UAU:'Tyr',UAC:'Tyr',UAA:'Stop',UAG:'Stop', CAU:'His',CAC:'His',CAA:'Gln',CAG:'Gln', AAU:'Asn',AAC:'Asn',AAA:'Lys',AAG:'Lys', GAU:'Asp',GAC:'Asp',GAA:'Glu',GAG:'Glu', UGU:'Cys',UGC:'Cys',UGA:'Stop',UGG:'Trp', CGU:'Arg',CGC:'Arg',CGA:'Arg',CGG:'Arg', AGU:'Ser',AGC:'Ser',AGA:'Arg',AGG:'Arg', GGU:'Gly',GGC:'Gly',GGA:'Gly',GGG:'Gly' },
      aaToWord: { Met:'Start',Ala:'I',Arg:'you',Asn:'we',Asp:'teacher',Cys:'pizza',Gln:'homework',Glu:'music',Gly:'play',His:'eat',Ile:'like',Leu:'can',Lys:'big',Phe:'smelly',Pro:'good',Ser:'bad',Thr:'with',Trp:'the',Tyr:'cat',Val:'dog' },
      lastMutation: null
    };

    // ===================== HELPERS =====================
    function el(s){ return document.querySelector(s); }
    function make(tag, props){ var e=document.createElement(tag); if(props) for(var k in props){ e[k]=props[k]; } return e; }
    function transcribeDNA(dna){ var map={A:'U',T:'A',G:'C',C:'G'}; var out=''; for(var i=0;i<dna.length;i++){ out+=map[dna[i]]||''; } return out; }
    function findFirstAUG(mrna){ return mrna.indexOf('AUG'); }
    function translateMRNA(mrna){
      var start=findFirstAUG(mrna); if(start<0) return {aa:[], codonStarts:[], start:start};
      var aa=[], codonStarts=[];
      for(var i=start;i+2<mrna.length;i+=3){ var c=mrna.slice(i,i+3); var a=state.codonToAA[c]; if(!a) break; if(a==='Stop') return {aa:aa,codonStarts:codonStarts,start:start}; aa.push(a); codonStarts.push(i);} return {aa:aa,codonStarts:codonStarts,start:start};
    }
    function dnaToEverything(dna){ var mrna=transcribeDNA(dna); var t=translateMRNA(mrna); var words=[]; for(var i=0;i<t.aa.length;i++){ words.push(state.aaToWord[t.aa[i]]||''); } return {dna:dna,mrna:mrna,start:t.start,aa:t.aa,codonStarts:t.codonStarts,words:words}; }

    // ===================== PART 1 (Practice) =====================
    function buildPractice(container, data){
      container.innerHTML='';
      var tpl=el('#tmpl-block'); var block=tpl.content.cloneNode(true);
      // DNA
      var dnaGrid=block.querySelector('.dna-grid'); dnaGrid.style.display='grid'; dnaGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      for(var i=0;i<data.dna.length;i++){ dnaGrid.appendChild(make('div',{className:'cell',textContent:data.dna[i]})); }
      // mRNA inputs
      var mrnaGrid=block.querySelector('.mrna-grid'); mrnaGrid.style.display='grid'; mrnaGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      var mrnaInputs=[]; for(i=0;i<data.dna.length;i++){ var input=make('input',{className:'base-input',maxLength:1,placeholder:''}); input.addEventListener('input',function(e){ e.target.value=(e.target.value||'').toUpperCase().replace(/[^AUGC]/g,''); }); mrnaGrid.appendChild(input); mrnaInputs.push(input);}      
      // AA inputs (3-letter)
      var aaGrid=block.querySelector('.aa-grid'); aaGrid.style.display='grid'; aaGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      var aaInputs=[]; var aug=data.start; for(i=0;i<(aug<0?data.dna.length:aug);i++) aaGrid.appendChild(make('div',{className:'slot'})); if(aug>=0){ var tr=translateMRNA(data.mrna); for(var k=0;k<tr.aa.length;k++){ var inp=make('input',{className:'codon-input',placeholder:'3-letter e.g., Met'}); aaInputs.push(inp); aaGrid.appendChild(inp);} var filled=aug+tr.aa.length*3; for(i=filled;i<data.dna.length;i++) aaGrid.appendChild(make('div',{className:'slot'})); }
      // Words inputs
      var wordsGrid=block.querySelector('.words-grid'); wordsGrid.style.display='grid'; wordsGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      var wordInputs=[]; for(i=0;i<(aug<0?data.dna.length:aug);i++) wordsGrid.appendChild(make('div',{className:'slot'})); if(aug>=0){ var tr2=translateMRNA(data.mrna); for(k=0;k<tr2.aa.length;k++){ var inp2=make('input',{className:'codon-input word',placeholder:'word'}); wordInputs.push(inp2); wordsGrid.appendChild(inp2);} filled=aug+tr2.aa.length*3; for(i=filled;i<data.dna.length;i++) wordsGrid.appendChild(make('div',{className:'slot'})); }
      // Check buttons
      block.querySelector('[data-action="check-mrna"]').addEventListener('click',function(){ var expected=data.mrna; var tac=data.dna.indexOf('TAC'); var correct=0; for(var j=0;j<expected.length;j++){ var cell=mrnaInputs[j]; var val=(cell.value||'').toUpperCase(); var exp=expected[j]; if(j<Math.max(0,tac)){ if(!val){ cell.classList.remove('badcell','goodcell'); cell.classList.add('neutral'); continue; } else { cell.classList.add('badcell'); cell.classList.remove('goodcell','neutral'); continue; } } if(val===exp){ cell.classList.add('goodcell'); cell.classList.remove('badcell','neutral'); correct++; } else { cell.classList.add('badcell'); cell.classList.remove('goodcell','neutral'); } } block.querySelector('[data-score-mrna]').textContent='Correct: '+correct+'/'+expected.length; });
      block.querySelector('[data-action="check-aa"]').addEventListener('click',function(){ var tr=translateMRNA(data.mrna); var correct=0; for(var j=0;j<aaInputs.length;j++){ var cell=aaInputs[j]; var v=(cell.value||'').trim(); var norm=v.slice(0,1).toUpperCase()+v.slice(1,3).toLowerCase(); if(!v){ cell.classList.remove('goodcell','badcell'); cell.classList.add('neutral'); continue;} if(norm===tr.aa[j]){ cell.classList.add('goodcell'); cell.classList.remove('badcell','neutral'); correct++; } else { cell.classList.add('badcell'); cell.classList.remove('goodcell','neutral'); } } block.querySelector('[data-score-aa]').textContent='Correct: '+correct+'/'+tr.aa.length; });
      block.querySelector('[data-action="check-words"]').addEventListener('click',function(){ var tr=translateMRNA(data.mrna); var expected=[]; for(var j=0;j<tr.aa.length;j++){ expected.push(state.aaToWord[tr.aa[j]]||''); } var correct=0; for(j=0;j<wordInputs.length;j++){ var cell=wordInputs[j]; var val=(cell.value||'').trim().toLowerCase(); var exp=(expected[j]||'').toLowerCase(); if(!val){ cell.classList.remove('goodcell','badcell'); cell.classList.add('neutral'); continue;} if(val===exp){ cell.classList.add('goodcell'); cell.classList.remove('badcell','neutral'); correct++; } else { cell.classList.add('badcell'); cell.classList.remove('goodcell','neutral'); } } block.querySelector('[data-score-words]').textContent='Correct: '+correct+'/'+expected.length; });
      container.appendChild(block);
    }

    // ===================== PART 2 (Viewer) =====================
    function buildViewerBlock(container, data, title){
      var card=make('div',{className:'card'});
      card.appendChild(make('div',{className:'row-label',textContent:title}));
      // DNA row
      var dnaGrid=make('div',{className:'grid'}); dnaGrid.style.display='grid'; dnaGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      for(var i=0;i<data.dna.length;i++){ dnaGrid.appendChild(make('div',{className:'cell',textContent:data.dna[i]})); }
      card.appendChild(make('div',{className:'row-label',textContent:'DNA'})); card.appendChild(dnaGrid);
      // mRNA from AUG
      var mGrid=make('div',{className:'grid'}); mGrid.style.display='grid'; mGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<data.dna.length;i++){ var ch=(data.start>=0 && i>=data.start)? data.mrna[i] : ''; mGrid.appendChild(make('div',{className: ch? 'cell':'slot', textContent: ch })); }
      card.appendChild(make('div',{className:'row-label',textContent:'mRNA (from AUG)'})); card.appendChild(mGrid);
      // Amino acids 3-letter
      var aaGrid=make('div',{className:'grid'}); aaGrid.style.display='grid'; aaGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<(data.start<0?data.dna.length:data.start);i++) aaGrid.appendChild(make('div',{className:'slot'}));
      if(data.start>=0){ for(var k=0;k<data.aa.length;k++){ aaGrid.appendChild(make('div',{className:'codon',textContent:data.aa[k]})); } var filled=data.start+data.aa.length*3; for(i=filled;i<data.dna.length;i++) aaGrid.appendChild(make('div',{className:'slot'})); }
      card.appendChild(make('div',{className:'row-label',textContent:'Amino acids (3-letter)'})); card.appendChild(aaGrid);
      // Words
      var wGrid=make('div',{className:'grid'}); wGrid.style.display='grid'; wGrid.style.gridTemplateColumns='repeat('+data.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<(data.start<0?data.dna.length:data.start);i++) wGrid.appendChild(make('div',{className:'slot'}));
      if(data.start>=0){ for(k=0;k<data.aa.length;k++){ wGrid.appendChild(make('div',{className:'codon word',textContent: state.aaToWord[data.aa[k]]||''})); } filled=data.start+data.aa.length*3; for(i=filled;i<data.dna.length;i++) wGrid.appendChild(make('div',{className:'slot'})); }
      card.appendChild(make('div',{className:'row-label',textContent:'Words'})); card.appendChild(wGrid);
      container.appendChild(card);
    }

    function buildMutatedBlock(container, mutData, mutInfo){
      var card=make('div',{className:'card'});
      var head=make('div',{className:'row-head'});
      head.appendChild(make('div',{className:'row-label',textContent:'Mutated ('+mutInfo.label+' at position '+(mutInfo.pos+1)+')'}));
      var rerunBtn=make('button',{className:'btn', id:'btnRerunInline', textContent:'Re-run mutation'});
      rerunBtn.addEventListener('click', function(){ renderViewer(); });
      head.appendChild(rerunBtn); card.appendChild(head);
      // DNA with highlight
      var dnaGrid=make('div',{className:'grid'}); dnaGrid.style.display='grid'; dnaGrid.style.gridTemplateColumns='repeat('+mutData.dna.length+', minmax(26px, 1fr))';
      for(var i=0;i<mutData.dna.length;i++){ var c=make('div',{className:'cell',textContent:mutData.dna[i]}); if(i===mutInfo.highlightIndex){ c.classList.add('mark'); c.title=mutInfo.desc; } dnaGrid.appendChild(c); }
      card.appendChild(dnaGrid);
      // mRNA from AUG
      var mGrid=make('div',{className:'grid'}); mGrid.style.display='grid'; mGrid.style.gridTemplateColumns='repeat('+mutData.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<mutData.dna.length;i++){ var ch=(mutData.start>=0 && i>=mutData.start)? mutData.mrna[i] : ''; mGrid.appendChild(make('div',{className: ch? 'cell':'slot', textContent: ch })); }
      card.appendChild(make('div',{className:'row-label',textContent:'Mutated mRNA (from AUG)'})); card.appendChild(mGrid);
      // AA 3-letter
      var aaGrid=make('div',{className:'grid'}); aaGrid.style.display='grid'; aaGrid.style.gridTemplateColumns='repeat('+mutData.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<(mutData.start<0?mutData.dna.length:mutData.start);i++) aaGrid.appendChild(make('div',{className:'slot'}));
      if(mutData.start>=0){ for(var k=0;k<mutData.aa.length;k++){ aaGrid.appendChild(make('div',{className:'codon',textContent:mutData.aa[k]})); } var filled=mutData.start+mutData.aa.length*3; for(i=filled;i<mutData.dna.length;i++) aaGrid.appendChild(make('div',{className:'slot'})); }
      card.appendChild(make('div',{className:'row-label',textContent:'amino acids (3-letter)'})); card.appendChild(aaGrid);
      // Words
      var wGrid=make('div',{className:'grid'}); wGrid.style.display='grid'; wGrid.style.gridTemplateColumns='repeat('+mutData.dna.length+', minmax(26px, 1fr))';
      for(i=0;i<(mutData.start<0?mutData.dna.length:mutData.start);i++) wGrid.appendChild(make('div',{className:'slot'}));
      if(mutData.start>=0){ for(k=0;k<mutData.aa.length;k++){ wGrid.appendChild(make('div',{className:'codon word',textContent: state.aaToWord[mutData.aa[k]]||''})); } filled=mutData.start+mutData.aa.length*3; for(i=filled;i<mutData.dna.length;i++) wGrid.appendChild(make('div',{className:'slot'})); }
      card.appendChild(make('div',{className:'row-label',textContent:'Mutated Sentence'})); card.appendChild(wGrid);
      container.appendChild(card);
    }

    // ===================== MUTATIONS =====================
    function findCodingBounds(dna){
      var mrna=transcribeDNA(dna); var start=findFirstAUG(mrna); if(start<0) return null; var stop=mrna.length; for(var i=start;i+2<mrna.length;i+=3){ var c=mrna.slice(i,i+3); var a=state.codonToAA[c]; if(!a) break; if(a==='Stop'){ stop=i; break; } } return {start:start, stop:stop};
    }
    function mutateDNA(dna, type, codingOnly){
      var bases=['A','T','G','C']; var posMin=0, posMax=dna.length-1;
      if(codingOnly){ var b=findCodingBounds(dna); if(b && b.start>=0){ posMin=Math.min(dna.length-1, b.start+3); var stopIdx=(typeof b.stop==='number')? b.stop : dna.length; posMax=Math.max(posMin, stopIdx-1); } }
      if(posMax<posMin){ posMin=0; posMax=dna.length-1; }
      var pos=posMin+Math.floor(Math.random()*((posMax-posMin)+1));
      if(type==='sub'){ var original=dna[pos]; var pool=bases.filter(function(x){return x!==original;}); var repl=pool[Math.floor(Math.random()*pool.length)]; return { type:type, pos:pos, desc:'Base '+original+'→'+repl, dna: dna.slice(0,pos)+repl+dna.slice(pos+1), highlightIndex: pos, label:'Substitution' }; }
      if(type==='del'){ return { type:type, pos:pos, desc:'Deleted '+dna[pos], dna: dna.slice(0,pos)+dna.slice(pos+1), highlightIndex: Math.min(pos, dna.length-2), label:'Deletion' }; }
      if(type==='ins'){ var ins=bases[Math.floor(Math.random()*bases.length)]; return { type:type, pos:pos, desc:'Inserted '+ins, dna: dna.slice(0,pos)+ins+dna.slice(pos), highlightIndex: pos, label:'Insertion' }; }
      return { type:'sub', pos:0, desc:'(fallback)', dna:dna, highlightIndex:0, label:'Substitution' };
    }

    // ===================== RENDERERS =====================
    function renderPracticeByIndex(idx){ var dna=state.sequences[idx]; var data=dnaToEverything(dna); var host=el('#originalBlock'); if(!host) return; host.innerHTML=''; buildPractice(host, data); var meta=el('#currentMeta'); if(meta) meta.textContent='Sentence: '+(idx+1)+' • Length: '+dna.length; }

    function renderViewer(){
      var pEl=el('#pickNumber2'); var tEl=el('#mutType2'); var status=el('#p2Status');
      if(!pEl || !tEl){ return; }
      var sel=pEl.value; if(!sel){ if(status) status.textContent='Pick a sentence first'; return; }
      var idx=parseInt(sel,10); var type=tEl.value || 'sub'; var originalDNA=state.sequences[idx]; if(!originalDNA){ if(status) status.textContent='Invalid sentence'; return; }
      var oData=dnaToEverything(originalDNA); var mut=mutateDNA(originalDNA, type, true); state.lastMutation={idx:idx, type:type}; var mData=dnaToEverything(mut.dna);
      var host=el('#quickViewer'); if(!host) return; host.innerHTML='';
      var headO=make('div',{className:'section-title'}); headO.appendChild(make('strong',{textContent:'Original • Sentence '+(idx+1)})); headO.appendChild(make('span',{className:'pill',textContent:'Length: '+originalDNA.length})); host.appendChild(headO);
      buildViewerBlock(host, oData, 'Original (unmutated)');
      var headM=make('div',{className:'section-title'}); headM.appendChild(make('strong',{textContent:'Mutated • '+mut.label+' at position '+(mut.pos+1)})); headM.appendChild(make('span',{className:'pill',textContent:mut.desc})); host.appendChild(headM);
      buildMutatedBlock(host, mData, mut);
      if(status) status.textContent='Rendered';
    }

    // ===================== INIT =====================
    function initTheme(){ var t=el('#themeToggle'); var saved=localStorage.getItem('g10-theme')||'dark'; document.documentElement.setAttribute('data-theme', saved==='light'?'light':'dark'); if(t){ t.checked=(saved==='light'); t.addEventListener('change', function(){ var mode=t.checked?'light':'dark'; document.documentElement.setAttribute('data-theme',mode); localStorage.setItem('g10-theme',mode); }); } }

    function initControls(){
      // Part 1
      var btnLoad=el('#btnLoad'); if(btnLoad){ btnLoad.addEventListener('click', function(){ var v=el('#pickNumber').value; if(v==='') return; renderPracticeByIndex(parseInt(v,10)); }); }
      var pick1=el('#pickNumber'); if(pick1){ pick1.addEventListener('change', function(e){ if(e.target.value==='') return; renderPracticeByIndex(parseInt(e.target.value,10)); }); }
      var btnReset=el('#btnReset'); if(btnReset){ btnReset.addEventListener('click', function(){ var ob=el('#originalBlock'); if(ob) ob.innerHTML=''; var cm=el('#currentMeta'); if(cm) cm.textContent='Sentence: —'; }); }
      // Part 2
      var btnRun=el('#btnRun'); if(btnRun){ btnRun.addEventListener('click', renderViewer); }
      var pick2=el('#pickNumber2'); if(pick2){ pick2.addEventListener('change', function(){ if(pick2.value!=='') renderViewer(); }); }
      var mut2=el('#mutType2'); if(mut2){ mut2.addEventListener('change', function(){ var p=el('#pickNumber2'); if(p && p.value!=='') renderViewer(); }); }
      var btnResetP2=el('#btnResetP2'); if(btnResetP2){ btnResetP2.addEventListener('click', function(){ var qv=el('#quickViewer'); if(qv) qv.innerHTML=''; var st=el('#p2Status'); if(st) st.textContent=''; }); }
    }

    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', function(){ initTheme(); initControls(); });
    } else { initTheme(); initControls(); }
  </script>
</body>
</html>
